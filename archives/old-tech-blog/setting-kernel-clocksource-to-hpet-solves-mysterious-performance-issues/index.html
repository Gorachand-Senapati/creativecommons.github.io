<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="shortcut icon" type="image/x-icon" href="../../../static/favicon.ico">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet"> 
<link rel="stylesheet" href="../../../static/gen/style.css">
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
<script type="text/javascript" src="../../../static/gen/script.js"></script>
<title>Setting kernel clocksource to HPET solves mysterious performance issues â€” Creative Commons on GitHub</title>
<body>
  <div class="ga-script">
<div id="ga-script"></div>
<script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-2010376-37', 'auto');
        ga('send', 'pageview');
</script>
</div>
  <header class="main-header">
    <div class="container-fluid">
      <div class="row justify-content-md-center">
        <div class="col-9">
          <nav class="navbar navbar-expand-xl navbar-dark" name="top">
            
            <a class="navbar-brand" href="../../../">
              <img src="../../../cclogo.svg">
              <span class="legend">Creative Commons Open Source</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
        
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../../../">Home</a></li>
                
                  <li class="nav-item">
                    <a class="nav-link" href="../../../contributing-code/">Contributing Code</a>
                  </li>
                
                  <li class="nav-item">
                    <a class="nav-link" href="../../../projects/">Projects</a>
                  </li>
                
                <li class="nav-item dropdown ">
                  <a class="nav-link" href="#" id="navbarCommunityDropdown" role="button">Community</a>
                  <div class="dropdown-menu" aria-labelledby="navbarCommunityDropdown">
                    
                      <a class="dropdown-item" href="../../../community/">Join the Community</a>
                    
                      <a class="dropdown-item" href="../../../community/code-of-conduct/">Code of Conduct</a>
                    
                      <a class="dropdown-item" href="../../../community/code-of-conduct/enforcement/">Code of Conduct Enforcement</a>
                    
                  </div>
                </li>
                <li class="nav-item dropdown ">
                  <a class="nav-link" href="#" id="navbarGSoCDropdown" role="button">GSoC 2019</a>
                  <div class="dropdown-menu" aria-labelledby="navbarGSoCDropdown">
                    
                      <a class="dropdown-item" href="../../../gsoc-2019/">General Information</a>
                    
                      <a class="dropdown-item" href="../../../gsoc-2019/project-ideas/all/">Project Ideas</a>
                    
                      <a class="dropdown-item" href="../../../gsoc-2019/student-expectations/">Student Expectations</a>
                    
                      <a class="dropdown-item" href="../../../gsoc-2019/application-instructions/">Application Instructions</a>
                    
                  </div>
                </li>
                <li class="nav-item dropdown  active">
                  <a class="nav-link" href="#" id="navbarArchivesDropdown" role="button">Archives</a>
                  <div class="dropdown-menu" aria-labelledby="navbarArchivesDropdown">
                    
                      <a class="dropdown-item" href="../../../archives/old-tech-blog/">CC Tech Blog (2007-2014)</a>
                    
                  </div>
                </li>
              </ul>
          </nav>
        </div>
      </div>
    </div>
  </header>
  <div class="container-fluid page-content">
    <div class="row justify-content-md-center">
      <div class="col-9 content-wrap">
        <div class="page py-3">
          <h1 class="page-title pb-3 mb-4">Archive: CC Technical Blog (2007-2014)</h1>
          
  <h2 class="mb-0">Setting kernel clocksource to HPET solves mysterious performance issues</h2>
  <p class="meta text-muted mt-0">by <a href="/blog/authors/nkinkade">nkinkade</a>
  on Tuesday, 2012 April 10</p>
  <div class="body"><p>For quite a long time the server which runs this very site has had some performance issues. This same server runs one or two instances of Mediawiki, and I have always just presumed that Mediawiki was the cause of the problems. I really didn't give it too much more thought, since the issues weren't causing many horrible user-facing performance issues. The server sort of hobbled along in the background, fairly loaded, but still managing to serve up pages decently. However, the problem most seriously manifested itself for me personally when working in a remote shell. Sometimes I'd go to save a file and the operation would take 10 or 15 seconds to complete. I ignored this, too, for some time, but it reached a point where I couldn't take it any longer.</p>
<p>I watched the output of top for a while, sorting on various metrics, and noticed that <em>flush</em> and <em>kjournald</em> were pegged at the top when sorted by process state, both being in a disk-wait ("D") state. This didn't make any sense to me, since the machine doesn't host any really busy sites and should have plenty of memory to handle what it has. I decided to do a web search for " <em>linux flush kswapd</em> " to see what it would turn up. As it turns out, the very <a href="http://old.nabble.com/Re%3A-kswapd-continuously-active-p27500336.html">first article</a> returned in the search ended up indirectly shedding light on this issue, even though it turned out to be mostly unrelated to my own problem. However, what I did take away from it was learning of a utility that I didn't previous know about. Namely, <em><a href="https://perf.wiki.kernel.org/">perf</a></em> , and specifically _<a href="https://perf.wiki.kernel.org/articles/t/u/t/Tutorial.html#Live_analysis_with_perf_top">perf top -a</a>_.</p>
<p>What I discovered upon running this command was that the kernel was spending a huge amount of time (60% to 80%) running the function _acpi_pm<em>read</em>. A little investigation on this tracked it back to the kernel <em>clocksource</em> being set to _acpi<em>pm</em>. The current, and available, clocksource(s) can be discovered by running the following, respectively:</p>
<pre><code>$ cat /sys/devices/system/clocksource/clocksource0/current_clocksource
$ cat /sys/devices/system/clocksource/clocksource0/available_clocksource
</code></pre>
<p>I then went to another machine, also running Mediawiki, but one not having any performance issues, and found its <em>clocksource</em> to be <em>hpet</em>. After a little more research, some experiementing, and a few reboots, I found that adding the kernel parameter <em>hpet=force</em> to the variable _GRUB_CMDLINE_LINUX<em>DEFAULT</em> in <em>/etc/default/grub</em> and then running <em>update-grub</em> got the system using <em>hpet</em> as the clocksource. And this seems to have totally cleared up the issues on the machine. Processor usage is way down, memory usage is way down, processes in the disk-wait state are down, and our Mediawiki site is returning pages much faster that it ever has.</p>
<p>For reference, here are a few machine specifications which might be useful for others investigating this:</p>
<ul>
<li>OS: Debian Squeeze</li>
<li>Processors: 2 x AMD Opteron 246</li>
</ul>
</div>
  <hr>
  <p class="meta mt-0 mb-0"><span class="text-muted">Categories: </span>
    
      none
    </p>

          <a id="back-to-top" href="#top" class="btn btn-dark btn-sm" role="button">Back to top</a>
        </div>
      </div>
    </div>
  </div>
  <footer class="main-footer bg-dark">
    <div class="container-fluid">
      <div class="row justify-content-md-center">
        <div class="col-9 footer text-light py-4 px-3">
          <small>
            <p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License"
                  style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a></p>
            <p class="text-muted">All the content on this website is licensed under a <strong><a rel="license"
                  href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International
                  License</a></strong> unless otherwise specified.</p>
          </small>
        </div>
      </div>
    </div>
  </footer>
</body>
